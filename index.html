
<html><head><base href="https://websimcreation.com/"><title>NFT Rewards Calculator</title><style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f0f0;
    }
    .input-group {
        margin-bottom: 15px;
    }
    input, button {
        padding: 10px;
        margin: 5px;
        font-size: 16px;
    }
    button {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover {
        background-color: #45a049;
    }
    #rewardsOutput {
        white-space: pre-wrap;
        background-color: white;
        border: 1px solid #ddd;
        padding: 10px;
        max-height: 400px;
        overflow-y: auto;
    }
    .adjustment-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .remove-adjustment {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        margin-left: 10px;
    }
    .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        padding: 15px 30px;
        font-size: 18px;
        background-color: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .back-button:hover {
        background-color: #2980b9;
    }
</style></head><body>
    <a href="https://miplix.github.io/servises/" class="back-button">Назад</a>

    <h1>Калькулятор наград NFT</h1>

    <div class="input-group">
        <label for="allocationInput">Общая аллокация:</label>
        <input type="number" id="allocationInput" value="100000000">
        <button onclick="updateRewards()">Обновить</button>
    </div>

    <div id="adjustments">
        <div class="adjustment-group">
            <input type="text" placeholder="Адрес" class="address-input">
            <input type="number" placeholder="Процент" class="percentage-input">
            <button class="remove-adjustment" onclick="removeAdjustment(this)">X</button>
        </div>
    </div>

    <button onclick="addAdjustment()">Добавить корректировку</button>

    <h2>Результат распределения наград</h2>
    <pre id="rewardsOutput"></pre>
    <button onclick="copyRewards()">Копировать</button>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        async function fetchNFTData() {
            const url = 'https://graph.mintbase.xyz/mainnet';
            const query = `
                query {
                    mb_views_nft_tokens(
                        where: {nft_contract_id: {_eq: "darai.mintbase1.near"}}
                    ) {
                        owner
                        title
                    }
                }
            `;

            try {
                const response = await axios.post(url, { query }, {
                    headers: { 'mb-api-key': 'anon' }
                });
                return response.data.data.mb_views_nft_tokens;
            } catch (error) {
                console.error('Ошибка:', error.response ? `${error.response.status} - ${error.response.statusText}` : error.message);
                return null;
            }
        }

        function parseStakingPower(title) {
            const mapping = {
                '0': '100%',
                '1': '50%',
                '2': '25%',
                '3': '12.5%',
                '4': '6.25%',
                'legendary': '3.125%',
                'epic': '1.5625%',
                'rare': '0.78125%',
                'uncommon': '0.390625%',
                'common': '0.1953125%'
            };

            const matchedKey = Object.keys(mapping).find(key => title.toLowerCase().includes(key));
            return matchedKey ? mapping[matchedKey] : 'N/A';
        }

        function convertStakingPowerToNumber(stakingPower) {
            const mapping = {
                '100%': 100,
                '50%': 50,
                '25%': 25,
                '12.5%': 12.5,
                '6.25%': 6.25,
                '3.125%': 3.125,
                '1.5625%': 1.5625,
                '0.78125%': 0.78125,
                '0.390625%': 0.390625,
                '0.1953125%': 0.1953125,
            };

            return mapping[stakingPower] || 0;
        }

        function shouldIncludeNFT(title, owner) {
            const excludeWords = ['passport', 'egg', 'yupik - chiter', 'тест', 'boost'];
            return !excludeWords.some(word => title ? title.toLowerCase().includes(word.toLowerCase()) : false) &&
                   owner !== 'darai_nft.near';
        }

        async function updateRewards() {
            const totalAllocation = parseFloat(document.getElementById('allocationInput').value);
            const nftData = await fetchNFTData();
            if (nftData) {
                const ownerStakingPower = {};

                nftData.forEach(nft => {
                    if (nft.owner !== '0000000000000000000000000000000000000000000000000000000000000000' && 
                        shouldIncludeNFT(nft.title, nft.owner)) {
                        const stakingPower = parseStakingPower(nft.title);
                        const stakingPowerValue = convertStakingPowerToNumber(stakingPower);

                        if (!ownerStakingPower[nft.owner]) {
                            ownerStakingPower[nft.owner] = 0;
                        }
                        ownerStakingPower[nft.owner] += stakingPowerValue;
                    }
                });

                // Apply adjustments
                const adjustments = document.querySelectorAll('.adjustment-group');
                adjustments.forEach(adjustment => {
                    const address = adjustment.querySelector('.address-input').value;
                    const percentage = parseFloat(adjustment.querySelector('.percentage-input').value);
                    if (address && !isNaN(percentage)) {
                        if (!ownerStakingPower[address]) {
                            ownerStakingPower[address] = 0;
                        }
                        ownerStakingPower[address] += percentage;
                    }
                });

                const totalPower = Object.values(ownerStakingPower).reduce((acc, value) => acc + value, 0);
                const rewardPerPercent = totalAllocation / totalPower;

                let rewardText = '';
                Object.entries(ownerStakingPower).forEach(([owner, totalPower]) => {
                    const reward = Math.floor(rewardPerPercent * totalPower);
                    rewardText += `${owner};${reward}\n`;
                });

                document.getElementById('rewardsOutput').textContent = rewardText;
            } else {
                document.getElementById('rewardsOutput').textContent = 'Нет доступных данных';
            }
        }

        function addAdjustment() {
            const adjustmentGroup = document.createElement('div');
            adjustmentGroup.className = 'adjustment-group';
            adjustmentGroup.innerHTML = `
                <input type="text" placeholder="Адрес" class="address-input">
                <input type="number" placeholder="Процент" class="percentage-input">
                <button class="remove-adjustment" onclick="removeAdjustment(this)">X</button>
            `;
            document.getElementById('adjustments').appendChild(adjustmentGroup);
        }

        function removeAdjustment(button) {
            button.parentElement.remove();
        }

        function copyRewards() {
            const rewardsOutput = document.getElementById('rewardsOutput');
            const textArea = document.createElement('textarea');
            textArea.value = rewardsOutput.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Текст скопирован в буфер обмена!');
        }

        // Initial update
        updateRewards();
    </script>
</body></html>
