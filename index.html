
<html><head><base href="https://websimcreation.com/"><title>NFT Rewards Calculator</title><style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f0f0;
    }
    .header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    h1 {
        margin: 0;
        flex-grow: 1;
    }
    .input-group {
        margin-bottom: 15px;
    }
    input, button {
        padding: 10px;
        margin: 5px;
        font-size: 16px;
    }
    button {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover {
        background-color: #45a049;
    }
    .rewards-output {
        white-space: pre-wrap;
        background-color: white;
        border: 1px solid #ddd;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
        font-size: 14px;
        transition: background-color 0.3s ease;
    }
    .rewards-output.copied {
        background-color: #ffcccc;
    }
    .adjustment-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .remove-adjustment {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        margin-left: 10px;
    }
    .back-button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: rgba(52, 152, 219, 0.7);
        color: white;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        border-radius: 20px;
        transition: background-color 0.3s;
        margin-right: 20px;
    }
    .back-button:hover {
        background-color: rgba(41, 128, 185, 0.7);
    }
</style></head><body>
    <div class="header">
        <a href="https://miplix.github.io/servises/" class="back-button">Назад</a>
        <h1>Калькулятор наград NFT</h1>
    </div>

    <div class="input-group">
        <label for="allocationInput">Общая аллокация:</label>
        <input type="number" id="allocationInput" value="100000000">
        <button onclick="updateRewards()">Обновить</button>
    </div>

    <div id="adjustments">
        <div class="adjustment-group">
            <input type="text" placeholder="Адрес" class="address-input">
            <input type="number" placeholder="Процент" class="percentage-input">
            <button class="remove-adjustment" onclick="removeAdjustment(this)">X</button>
        </div>
    </div>

    <button onclick="addAdjustment()">Добавить корректировку</button>

    <h2>Результат распределения наград</h2>
    <div id="rewardsOutputContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        async function fetchNFTData() {
            const url = 'https://graph.mintbase.xyz/mainnet';
            const query = `
                query {
                    mb_views_nft_tokens(
                        where: {nft_contract_id: {_eq: "darai.mintbase1.near"}}
                    ) {
                        owner
                        title
                    }
                }
            `;

            try {
                const response = await axios.post(url, { query }, {
                    headers: { 'mb-api-key': 'anon' }
                });
                return response.data.data.mb_views_nft_tokens;
            } catch (error) {
                console.error('Ошибка:', error.response ? `${error.response.status} - ${error.response.statusText}` : error.message);
                return null;
            }
        }

        function parseStakingPower(title) {
            const mapping = {
                '0': '100%',
                '1': '50%',
                '2': '25%',
                '3': '12.5%',
                '4': '6.25%',
                'legendary': '3.125%',
                'epic': '1.5625%',
                'rare': '0.78125%',
                'uncommon': '0.390625%',
                'common': '0.1953125%'
            };

            const matchedKey = Object.keys(mapping).find(key => title.toLowerCase().includes(key));
            return matchedKey ? mapping[matchedKey] : 'N/A';
        }

        function convertStakingPowerToNumber(stakingPower) {
            const mapping = {
                '100%': 100,
                '50%': 50,
                '25%': 25,
                '12.5%': 12.5,
                '6.25%': 6.25,
                '3.125%': 3.125,
                '1.5625%': 1.5625,
                '0.78125%': 0.78125,
                '0.390625%': 0.390625,
                '0.1953125%': 0.1953125,
            };

            return mapping[stakingPower] || 0;
        }

        function shouldIncludeNFT(title, owner) {
            const excludeWords = ['passport', 'egg', 'yupik - chiter', 'тест', 'boost'];
            const excludeOwners = ['darai_nft.near', 'darai_collection.near'];
            return !excludeWords.some(word => title ? title.toLowerCase().includes(word.toLowerCase()) : false) &&
                   !excludeOwners.includes(owner);
        }

        async function updateRewards() {
            const totalAllocation = parseFloat(document.getElementById('allocationInput').value);
            const nftData = await fetchNFTData();
            if (nftData) {
                const ownerStakingPower = {};

                nftData.forEach(nft => {
                    if (nft.owner !== '0000000000000000000000000000000000000000000000000000000000000000' && 
                        shouldIncludeNFT(nft.title, nft.owner)) {
                        const stakingPower = parseStakingPower(nft.title);
                        const stakingPowerValue = convertStakingPowerToNumber(stakingPower);

                        if (!ownerStakingPower[nft.owner]) {
                            ownerStakingPower[nft.owner] = 0;
                        }
                        ownerStakingPower[nft.owner] += stakingPowerValue;
                    }
                });

                // Apply adjustments
                const adjustments = document.querySelectorAll('.adjustment-group');
                adjustments.forEach(adjustment => {
                    const address = adjustment.querySelector('.address-input').value;
                    const percentage = parseFloat(adjustment.querySelector('.percentage-input').value);
                    if (address && !isNaN(percentage)) {
                        if (!ownerStakingPower[address]) {
                            ownerStakingPower[address] = 0;
                        }
                        ownerStakingPower[address] += percentage;
                    }
                });

                const totalPower = Object.values(ownerStakingPower).reduce((acc, value) => acc + value, 0);
                const rewardPerPercent = totalAllocation / totalPower;

                let rewardText = '';
                Object.entries(ownerStakingPower).forEach(([owner, totalPower]) => {
                    const reward = (rewardPerPercent * totalPower).toFixed(2);
                    rewardText += `${owner};${reward}\n`;
                });

                // Split rewards into groups of 100 lines
                const rewardGroups = rewardText.split('\n').reduce((acc, line, index) => {
                    if (index % 100 === 0) acc.push('');
                    acc[acc.length - 1] += line + '\n';
                    return acc;
                }, []);

                // Create output fields for each group
                const container = document.getElementById('rewardsOutputContainer');
                container.innerHTML = '';
                rewardGroups.forEach((group, index) => {
                    const outputField = document.createElement('textarea');
                    outputField.className = 'rewards-output';
                    outputField.readOnly = true;
                    outputField.value = group.trim();
                    container.appendChild(outputField);

                    const copyButton = document.createElement('button');
                    copyButton.textContent = 'Копировать';
                    copyButton.onclick = () => copyRewards(outputField);
                    container.appendChild(copyButton);
                });
            } else {
                document.getElementById('rewardsOutputContainer').innerHTML = '<p>Нет доступных данных</p>';
            }
        }

        function addAdjustment() {
            const adjustmentGroup = document.createElement('div');
            adjustmentGroup.className = 'adjustment-group';
            adjustmentGroup.innerHTML = `
                <input type="text" placeholder="Адрес" class="address-input">
                <input type="number" placeholder="Процент" class="percentage-input">
                <button class="remove-adjustment" onclick="removeAdjustment(this)">X</button>
            `;
            document.getElementById('adjustments').appendChild(adjustmentGroup);
        }

        function removeAdjustment(button) {
            button.parentElement.remove();
        }

        function copyRewards(outputField) {
            outputField.select();
            document.execCommand('copy');
            outputField.setSelectionRange(0, 0);
            outputField.classList.add('copied');
        }

        // Initial update
        updateRewards();
    </script>
</body></html>
