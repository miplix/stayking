
<html><head><base href="https://websimcreation.com/"><title>NFT Rewards Calculator</title><style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f0f0;
    }
    .header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    h1 {
        margin: 0;
        flex-grow: 1;
    }
    .back-button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: rgba(52, 152, 219, 0.7);
        color: white;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        border-radius: 20px;
        transition: background-color 0.3s;
        margin-right: 20px;
    }
    .back-button:hover {
        background-color: rgba(41, 128, 185, 0.7);
    }
    .input-group {
        margin-bottom: 15px;
    }
    input, button {
        padding: 10px;
        margin: 5px;
        font-size: 16px;
    }
    button {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover {
        background-color: #45a049;
    }
    #rewardsOutput {
        white-space: pre-wrap;
        background-color: white;
        border: 1px solid #ddd;
        padding: 10px;
        height: 400px;
        overflow-y: auto;
        margin-bottom: 10px;
        font-size: 14px;
    }
    #loading, #error {
        margin-top: 20px;
        font-weight: bold;
    }
    #error {
        color: red;
    }
    .additional-power-container {
        margin-top: 20px;
    }
    .additional-power-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .additional-power-row input {
        flex: 1;
        margin-right: 10px;
    }
    .delete-button {
        background-color: #f44336;
        color: white;
        border: none;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 14px;
    }
    .add-button {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        padding: 10px 20px;
        font-size: 16px;
        margin-top: 10px;
    }
</style></head>
<body>
    <div class="header">
        <a href="https://miplix.github.io/servises/" class="back-button">Назад</a>
        <h1>NFT Rewards Calculator</h1>
    </div>

    <div class="input-group">
        <label for="allocationInput">Общая аллокация:</label>
        <input type="number" id="allocationInput" value="100000000">
    </div>

    <div class="additional-power-container">
        <h3>Добавочная мощность</h3>
        <div id="additionalPowerList"></div>
        <button class="add-button" onclick="addAdditionalPowerRow()">Добавить</button>
    </div>

    <button onclick="calculateRewards()">Рассчитать награды</button>

    <h2>Результат распределения наград</h2>
    <div id="rewardsOutput"></div>

    <div id="loading" style="display: none;">Загрузка данных...</div>
    <div id="error" style="display: none;"></div>

    <script>
        let allNFTs = [];
        let additionalPowerRows = 0;

        async function fetchNFTs() {
            let page = 1;
            const perPage = 250;
            let hasMore = true;
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            
            const excludedOwners = [
                '0000000000000000000000000000000000000000000000000000000000000000',
                'darai_nft.near',
                'darai_collection.near'
            ];

            const excludedTitles = ['egg', 'passport', 'Yupik - Chiter', 'Chest', 'Press', 'тест', 'boost', 'mystical'];

            const powerLevels = {
                '0': 100,
                '1': 50,
                '2': 25,
                '3': 12.5,
                '4': 6.25,
                'legendary': 3.125,
                'epic': 1.5625,
                'rare': 0.78125,
                'uncommon': 0.390625,
                'common': 0.1953125
            };

            while (hasMore) {
                try {
                    loadingElement.style.display = 'block';
                    errorElement.style.display = 'none';
                    
                    const response = await fetch(`https://api.nearblocks.io/v1/nfts/darai.mintbase1.near/tokens?page=${page}&per_page=${perPage}`);
                    const data = await response.json();

                    if (data && data.tokens && data.tokens.length > 0) {
                        const filteredData = data.tokens
                            .filter(token => {
                                if (!token.title) return false;
                                const lowerTitle = token.title.toLowerCase();
                                return !excludedTitles.some(excluded => lowerTitle.includes(excluded.toLowerCase())) &&
                                       !excludedOwners.includes(token.asset.owner);
                            })
                            .map(token => {
                                const titleLower = token.title.toLowerCase();
                                let power = 0;
                                for (const [key, value] of Object.entries(powerLevels)) {
                                    if (titleLower.includes(key)) {
                                        power = value;
                                        break;
                                    }
                                }
                                return {
                                    title: token.title,
                                    id: token.token || '-',
                                    owner: token.asset.owner,
                                    power: power
                                };
                            });

                        allNFTs = allNFTs.concat(filteredData);
                        page++;
                    } else {
                        hasMore = false;
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке данных:', error);
                    errorElement.textContent = 'Произошла ошибка при загрузке данных. Пожалуйста, попробуйте позже.';
                    errorElement.style.display = 'block';
                    hasMore = false;
                }
            }

            loadingElement.style.display = 'none';
        }

        function addAdditionalPowerRow() {
            const listElement = document.getElementById('additionalPowerList');
            const rowId = additionalPowerRows++;
            
            const row = document.createElement('div');
            row.className = 'additional-power-row';
            row.innerHTML = `
                <input type="text" id="addressInput${rowId}" placeholder="Адрес">
                <input type="number" id="powerInput${rowId}" placeholder="Мощность (%)" step="0.01">
                <button class="delete-button" onclick="removeAdditionalPowerRow(${rowId})">✖</button>
            `;
            listElement.appendChild(row);
        }

        function removeAdditionalPowerRow(rowId) {
            const row = document.querySelector(`#additionalPowerList .additional-power-row:nth-child(${rowId + 1})`);
            if (row) {
                row.remove();
            }
        }

        function calculateRewards() {
            const totalAllocation = parseFloat(document.getElementById('allocationInput').value);
            let totalPower = allNFTs.reduce((sum, nft) => sum + nft.power, 0);

            const ownerRewards = {};
            allNFTs.forEach(nft => {
                if (!ownerRewards[nft.owner]) {
                    ownerRewards[nft.owner] = 0;
                }
                ownerRewards[nft.owner] += nft.power;
            });

            // Add rewards for additional power
            for (let i = 0; i < additionalPowerRows; i++) {
                const addressInput = document.getElementById(`addressInput${i}`);
                const powerInput = document.getElementById(`powerInput${i}`);
                if (addressInput && powerInput) {
                    const address = addressInput.value;
                    const power = parseFloat(powerInput.value);
                    if (address && !isNaN(power)) {
                        if (!ownerRewards[address]) {
                            ownerRewards[address] = 0;
                        }
                        ownerRewards[address] += power;
                        totalPower += power;
                    }
                }
            }

            const rewardPerPercent = totalAllocation / totalPower;

            let rewardText = '';
            Object.entries(ownerRewards).forEach(([owner, power]) => {
                const reward = power * rewardPerPercent;
                rewardText += `${owner};${reward.toFixed(2)}\n`;
            });

            document.getElementById('rewardsOutput').textContent = rewardText;
        }

        // Initialize
        fetchNFTs();
        addAdditionalPowerRow(); // Add one row by default
    </script>
</body></html>
